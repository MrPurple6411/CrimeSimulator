# Modernized Crime Simulator Modding Workspace

A professional BepInEx modding workspace for Crime Simulator with automated build system, hybrid git tag versioning, and GitHub Actions CI/CD.

## 🚀 Quick Start

### Prerequisites
- .NET 8.0 SDK (can build .NET Framework 4.8 projects)
- Crime Simulator (Steam)
- BepInEx 5.4.21+ installed in game directory

> **Note**: While mods target .NET Framework 4.8 (required by Unity/BepInX), we use the modern .NET 8 SDK for building. This gives us access to modern tooling, MSBuild features, and C# language features while still producing .NET Framework 4.8 compatible assemblies.

### Quick Start for Contributors

1. **Clone the repository**:
   ```bash
   git clone https://github.com/MrPurple6411/CrimeSimulator.git
   cd CrimeSimulator
   ```

2. **Build a mod**:
   ```bash
   dotnet build src/{{EXAMPLE_MOD_NAME}}/{{EXAMPLE_MOD_NAME}}.csproj -c Debug
   ```

3. **Test in game** - The mod DLL is auto-copied to your BepInEx plugins folder!

### Setup for Maintainers Only

> **Note**: This step is only required for repository maintainers who need to update the game assemblies NuGet package when the game updates. Contributors can skip this.

**Process game assemblies** (when game updates):
```powershell
.\scripts\Process-Assemblies.ps1 1.4.4
# OR with auto-publish (commits, tags, and triggers CI/CD):
.\scripts\Process-Assemblies.ps1 1.4.4 -AutoPublish
```

## Project Structure

```
├── .github/workflows/          # GitHub Actions workflows
├── build/                      # MSBuild configuration
│   ├── Common.props           # Common project properties
│   └── BepInEx.targets        # BepInEx-specific build targets
├── src/                       # Your mod projects go here
├── Docs/                      # Documentation
├── CrimeSimulatorDecompiled/   # Decompiled game source (reference)
├── Directory.Build.props      # Global MSBuild properties
└── Directory.Build.targets    # Global MSBuild targets
```

## Creating a Mod

### 1. Project Template

Create a new mod project in the `src/` directory:

```xml
<Project Sdk="Microsoft.NET.Sdk">
  
  <PropertyGroup>
    <AssemblyTitle>My Awesome Mod</AssemblyTitle>
    <AssemblyDescription>Makes the game more awesome</AssemblyDescription>
    
    <!-- BepInEx Plugin Metadata (auto-generates MyPluginInfo) -->
    <PluginGuid>author.gamename.myawesomemod</PluginGuid>
    <PluginName>My Awesome Mod</PluginName>
    <PluginVersion>1.0.0</PluginVersion>
  </PropertyGroup>
  
</Project>
```

> **Note**: The `BepInEx.PluginInfoProps` package automatically generates the `MyPluginInfo` class from these properties, so you don't need to manually define the plugin metadata.

### 2. Basic Plugin Code

```csharp
using BepInEx;
using HarmonyLib;

namespace MyAwesomeMod
{
    [BepInPlugin(MyPluginInfo.PLUGIN_GUID, MyPluginInfo.PLUGIN_NAME, MyPluginInfo.PLUGIN_VERSION)]
    public class Plugin : BaseUnityPlugin
    {
        public static ManualLogSource Logger { get; private set; }

        private void Awake()
        {
            Logger = base.Logger;
            
            var harmony = new Harmony(MyPluginInfo.PLUGIN_GUID);
            harmony.PatchAll();
            
            Logger.LogInfo($"{MyPluginInfo.PLUGIN_NAME} v{MyPluginInfo.PLUGIN_VERSION} loaded!");
        }
    }
}
```

> **Note**: `MyPluginInfo` is automatically generated by `BepInEx.PluginInfoProps` from your project properties.

## Build Configurations

### Local Development

For local development with automatic copying to BepInEx plugins folder:

```bash
dotnet build -c Debug
```

This will:
- Build your mod
- Copy DLL and PDB files to `BepInEx/plugins/`
- Ready for testing in-game

### Release Build

For distribution:

```bash
dotnet build -c Release
```

This will:
- Build optimized release version
- Create a distributable ZIP package
- Generate NuGet package (if configured)

## MSBuild Features

### Automatic Game Detection

The build system automatically detects your Crime Simulator installation:

1. `C:\Program Files (x86)\Steam\steamapps\common\Crime Simulator`
2. `C:\Program Files\Steam\steamapps\common\Crime Simulator`  
3. `GameDir` environment variable
4. `GameDir` MSBuild property

### Custom MSBuild Targets

- **`ZipPlugins`** - Create distributable mod package

```bash
dotnet build -t:ZipPlugins     # Create mod package
```

## GitHub Actions

### Automated Builds

Every push triggers:
- Multi-configuration builds (Debug/Release)
- Automated testing
- Artifact generation
- NuGet package creation

### Assembly Publicization

The processing script uses **BepInEx.AssemblyPublicizer.Cli** to:
- **Publicize internal APIs** - Makes internal types/members accessible for Harmony patching
- **Strip assemblies** - Removes unnecessary code while keeping runtime safety  
- **Prevent duplicates** - Smart checking against existing tags and hashes
- **Auto-publish** - Optional automated git workflow

Only the core game assemblies are processed:
- `Assembly-CSharp.dll` - Main game logic
- `Assembly-CSharp-firstpass.dll` - First-pass scripts

### Release Automation

On GitHub releases:
- Build all mods
- Create distribution packages
- Publish to NuGet
- Attach assets to release

## NuGet Packages

### Game Assemblies Package

Publicized game assemblies are packaged as:
```
MrPurple6411.CrimeSimulator.GameAssemblies
```

This enables:
- CI/CD builds without game files
- Version-controlled dependencies
- Easy sharing between developers

### Using in Your Mods

The build system automatically references the NuGet package in CI environments and falls back to local assemblies for development:

```xml
<!-- Automatically handled by the build system -->
<PackageReference Include="MrPurple6411.CrimeSimulator.GameAssemblies" Version="1.0.0" PrivateAssets="all" Condition="'$(UseLocalGameAssemblies)' != 'true'" />
```

## Processing Game Assemblies (Maintainers Only)

> **For Repository Maintainers**: When the game updates, you'll need to process new assemblies and publish an updated NuGet package. Contributors don't need to do this step.

When the game updates, process assemblies locally with duplicate prevention:

```powershell
# Process new game version - automatically detects changes
.\scripts\Process-Assemblies.ps1 1.4.4

# Auto-publish if assemblies changed (commits, tags, triggers CI/CD)
.\scripts\Process-Assemblies.ps1 1.4.4 -AutoPublish

# Force reprocess even if no changes detected
.\scripts\Process-Assemblies.ps1 1.4.4 -Force
```

### Smart Duplicate Prevention

The script prevents unnecessary work by:
- **Checking GitHub tags** - Skips if `assemblies-v1.4.4` already published
- **Hash tracking** - Compares processed assemblies against previous runs
- **Auto-publish** - Only commits/tags if assemblies actually changed

### Output

Processed assemblies go to:
- `lib/net48/` - Publicized and stripped game assemblies
- `assembly-hashes.json` - Hash tracking for duplicate prevention

Unity dependencies are **not included** - use official Unity NuGet packages instead.

## Configuration

### Environment Variables

- `GAME_DIR` - Override game installation path
- `USE_LOCAL_ASSEMBLIES` - Force use of local game files instead of NuGet

### MSBuild Properties

- `GameDir` - Game installation directory
- `UseLocalGameAssemblies` - Use local game files (true/false)
- `PublicizeGameAssemblies` - Enable assembly publicization

## Debugging

### Visual Studio Setup

1. Set your mod project as startup project
2. Build in Debug mode (auto-copies to BepInEx/plugins/)
3. Launch the game manually through Steam or game executable
4. Attach debugger to running process if needed (advanced)

### VS Code Setup

For BepInEx mod development, direct debugging through VS Code is not supported. Use log-based debugging instead:

```csharp
Logger.LogInfo($"Debug info: {myVariable}");
Logger.LogWarning("Warning message");
```

## Contributing

1. Fork the repository
2. Create your mod in `src/YourModName/`
3. Follow the coding standards
4. Submit a pull request

## License

This project is licensed under the MIT License - see the [LICENSE](LICENSE) file for details.

## Acknowledgments

- **BepInEx Team** - For the excellent modding framework
- **Harmony** - For runtime patching capabilities

---

For detailed game analysis and modding insights, see [Game Analysis](Docs/GameAnalysis.md).